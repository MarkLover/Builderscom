generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  phone     String   @unique
  password  String
  name      String
  company   String?
  logo      String?  // URL or Base64
  role      String   @default("user") // "user" | "admin"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Subscription
  subscriptionActive Boolean   @default(false)
  subscriptionExpiry DateTime?

  projects         Project[]
  commercialOffers CommercialOffer[]
  companyUsers     CompanyUser[]
  companyExpenses  CompanyExpense[]
  expenseCategories ExpenseCategory[]
  payments         Payment[]
}

// Company Users (employees with limited access)
model CompanyUser {
  id        Int      @id @default(autoincrement())
  phone     String   @unique
  password  String
  name      String
  role      String   // e.g. "Менеджер", "Прораб"
  
  ownerId   Int
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Permissions
  canDashboard   Boolean @default(true)
  canProjects    Boolean @default(true)
  canFinances    Boolean @default(false)
  canCommercial  Boolean @default(false)
  canEmployees   Boolean @default(false)
  canTasks       Boolean @default(true)
  canProfile     Boolean @default(false)
  canSubscription Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Project {
  id          Int      @id @default(autoincrement())
  title       String
  address     String?
  status      String   @default("ongoing") // "ongoing" | "completed" | "frozen"
  budget      Float    @default(0)
  startDate   DateTime @default(now())
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])

  employees   Employee[]
  tasks       Task[]
  stages      Stage[]
  transactions Transaction[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Stage {
  id        Int      @id @default(autoincrement())
  title     String
  budget    Float    @default(0)
  status    String   @default("planned") // "planned" | "in_progress" | "completed"
  
  projectId Int
  project   Project  @relation(fields: [projectId], references: [id])
  
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Employee {
  id        Int      @id @default(autoincrement())
  name      String
  role      String   // position/role
  phone     String?
  telegram  String?
  whatsapp  String?
  max       String?  // MAX messenger username
  status    String   @default("active") // "active" | "archived"
  avatar    String?
  
  userId    Int      // Owner of this employee record
  
  projectId Int?
  project   Project? @relation(fields: [projectId], references: [id])
  
  tasks     Task[]   @relation("AssignedTasks")
  commercialOffers CommercialOffer[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  status      String    @default("todo") // "draft" | "todo" | "in_progress" | "completed" | "cancelled"
  priority    String    @default("medium") // "low" | "medium" | "high"
  dueDate     DateTime?
  
  userId      Int       // Owner
  
  projectId   Int
  project     Project   @relation(fields: [projectId], references: [id])
  
  assigneeId  Int?
  assignee    Employee? @relation("AssignedTasks", fields: [assigneeId], references: [id])
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Company Expenses (расходы компании)
model CompanyExpense {
  id          Int      @id @default(autoincrement())
  description String
  amount      Float
  category    String   // rent | salary | fuel | taxes | other
  date        DateTime
  receipt     String?  // URL to file
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
}

// Expense Categories (статьи расходов)
model ExpenseCategory {
  id          Int      @id @default(autoincrement())
  name        String
  type        String   // recurring | one-time
  amount      Float    @default(0) // Planned amount
  description String?
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  payments    CategoryPayment[]
  
  createdAt   DateTime @default(now())
}

model CategoryPayment {
  id          Int      @id @default(autoincrement())
  amount      Float
  date        DateTime @default(now())
  description String?
  
  categoryId  Int
  category    ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
}

model Transaction {
  id          Int      @id @default(autoincrement())
  type        String   // "expense" | "income"
  amount      Float
  category    String   // "materials" | "labor" | "other"
  description String?
  date        DateTime @default(now())
  receipt     String?  // URL to receipt image/file

  projectId   Int
  project     Project  @relation(fields: [projectId], references: [id])
  
  stageId     Int?
  stage       Stage?   @relation(fields: [stageId], references: [id])
}

// Commercial Offers (КП)
model CommercialOffer {
  id           Int      @id @default(autoincrement())
  address      String
  customerName String?  // Customer full name
  customerPhone String? // Customer phone number
  discount      Float    @default(0)
  discountType  String   @default("percent") // "percent" | "fixed"
  planImage     String?  // URL to plan image
  
  executorId    Int?
  executor      Employee? @relation(fields: [executorId], references: [id])
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  rooms     CommercialOfferRoom[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommercialOfferRoom {
  id        Int    @id @default(autoincrement())
  name      String
  area      Float  @default(0)  // Floor area in m²
  wallArea  Float  @default(0)  // Wall area in m²
  
  offerId   Int
  offer     CommercialOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  
  works     CommercialOfferWork[]
  materials CommercialOfferMaterial[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommercialOfferWork {
  id       Int    @id @default(autoincrement())
  name     String
  quantity Float
  unit     String // "м2" | "шт" | "мп"
  price    Float
  discount Float  @default(0)
  discountType String @default("percent")
  
  roomId   Int
  room     CommercialOfferRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

model CommercialOfferMaterial {
  id       Int    @id @default(autoincrement())
  name     String
  quantity Float
  unit     String // "шт" | "упаковок" | "кг" | "мп" | "м2"
  price    Float
  discount Float  @default(0)
  discountType String @default("percent")
  
  roomId   Int
  room     CommercialOfferRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

// YooKassa Payments
model Payment {
  id          Int      @id @default(autoincrement())
  paymentId   String   @unique // YooKassa payment ID
  status      String   @default("pending") // "pending" | "waiting_for_capture" | "succeeded" | "canceled"
  amount      Float
  currency    String   @default("RUB")
  description String?
  metadata    Json?    // Store things like userId, months

  userId      Int
  user        User     @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
